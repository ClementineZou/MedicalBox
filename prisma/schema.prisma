// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Better Auth User Models
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified Boolean   @default(false)
  name          String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  twoFactorEnabled Boolean @default(false)
  
  // 强化隐私保护设置
  enhancedPrivacyEnabled Boolean @default(false) // 是否启用强化隐私保护
  privacyVerifyDuration  Int     @default(10)    // 免验证时长（分钟），默认10分钟
  
  // Relations
  sessions             Session[]
  accounts             Account[]
  referenceRanges      VitalSignReferenceRange[]
  medicines            Medicine[]
  vitalSigns           VitalSign[]
  medicineUsageRecords MedicineUsageRecord[]
  reminders            Reminder[]
  vitalSignReminders   VitalSignReminder[]
  loginHistory         LoginHistory[]
  trustedDevices       TrustedDevice[]
  privacyVerifications PrivacyVerification[]
}

// 隐私验证记录表
model PrivacyVerification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  verifyType  String   // 验证类型: totp, passkey, backup_code
  verifiedAt  DateTime @default(now()) // 验证时间
  expiresAt   DateTime // 过期时间
  sessionId   String?  // 关联的会话ID
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([expiresAt])
  @@index([sessionId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId         String
  providerId        String
  accessToken       String?
  refreshToken      String?
  idToken           String?
  expiresAt         DateTime?
  password          String?
  scope             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@unique([identifier, value])
}

// Two Factor Authentication
model TwoFactor {
  id        String   @id @default(cuid())
  userId    String
  secret    String
  backupCodes String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId])
}

// Passkey (WebAuthn)
model Passkey {
  id               String   @id @default(cuid())
  userId           String
  name             String?
  publicKey        String
  credentialID     String   @unique
  counter          Int
  deviceType       String
  backedUp         Boolean
  transports       String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([userId])
}

// Login History - 登录历史记录
model LoginHistory {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  ipAddress   String?  // IP地址
  userAgent   String?  // 浏览器信息
  location    String?  // 登录位置（可选，需要IP解析服务）
  deviceInfo  String?  // 设备信息
  loginMethod String   @default("email") // 登录方式: email, passkey, oauth
  success     Boolean  @default(true) // 登录是否成功
  failReason  String?  // 失败原因
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

// Trusted Device - 可信设备
model TrustedDevice {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  deviceName    String   // 设备名称
  deviceId      String   @unique // 设备唯一标识
  ipAddress     String?  // IP地址
  userAgent     String   // 浏览器信息
  lastUsed      DateTime @default(now()) // 最后使用时间
  trustExpires  DateTime // 信任过期时间（30天）
  isActive      Boolean  @default(true) // 是否激活
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@index([deviceId])
  @@index([trustExpires])
}

// 药物信息表
model Medicine {
  id          String   @id @default(cuid())
  barcode     String?  @unique // 条形码（自动生成，唯一）
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String   // 药品名称
  brand       String   // 品牌/厂家，必填
  category    String?  // 分类（如：感冒药、消炎药等）
  controlTypes String   // 管制分类（逗号分隔字符串）
  dosage      String   // 剂量规格，必填
  dosageUnit  String   // 剂量单位，下拉选
  quantity    Int      @default(0) // 数量（最小单位）
  quantityUnit String  // 数量单位，下拉选
  indications String?  // 适应症
  usage       String?  // 用法用量
  notes       String?  // 备注
  expiryDate  DateTime // 有效期
  approvalNo  String?  // 批准文号，可选
  location    String?  // 存放位置
  imageUrl    String?  // 药品图片
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // 关联用药记录
  usageRecords MedicineUsageRecord[]
  // 关联提醒
  reminders    Reminder[]
  
  @@index([userId])
  @@index([expiryDate])
  @@index([name])
}

// 用药提醒表
model Reminder {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  medicineId  String
  medicine    Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  
  title       String   // 提醒标题
  description String?  // 提醒描述
  reminderTime DateTime // 提醒时间
  frequency   String   // 频率（每天、每周、每月等）
  isActive    Boolean  @default(true) // 是否激活
  isCompleted Boolean  @default(false) // 是否已完成
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([medicineId])
  @@index([reminderTime])
}

// 用药记录表
model MedicineUsageRecord {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  medicineId  String
  medicine    Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  
  dosage      String   // 服用剂量
  usageTime   DateTime // 服用时间
  notes       String?  // 备注
  sideEffectNotes String? // 副作用记录
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([medicineId])
  @@index([usageTime])
}

// 生命体征记录表
model VitalSign {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type          String   // 体征类型（如：体温、血压等）
  value         Float    // 数值
  unit          String   // 单位
  measureTime   DateTime // 测量时间
  notes         String?  // 备注
  isNormal      Boolean  @default(true) // 是否正常范围
  referenceRange String? // 参考范围
  
  category      String?  // 分类（如空腹、餐后等）
  systolic      Int?     // 收缩压（用于血压）
  diastolic     Int?     // 舒张压（用于血压）
  glucoseContext String? // 血糖上下文（如空腹、餐后等）
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([measureTime])
  @@index([category])
}

// 生命体征提醒表
model VitalSignReminder {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title         String   // 提醒标题
  description   String?  // 提醒描述
  vitalSignType String   // 体征类型
  reminderTime  DateTime // 提醒时间
  frequency     String   // 频率：once(一次性), daily(每天), weekly(每周), monthly(每月)
  isActive      Boolean  @default(true) // 是否激活
  isCompleted   Boolean  @default(false) // 是否已完成
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@index([vitalSignType])
  @@index([reminderTime])
}

// 生命体征参考范围表
model VitalSignReferenceRange {
  id           String   @id @default(cuid())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  type         String   // 体征类型
  minValue     Float    // 最小值
  maxValue     Float    // 最大值
  unit         String   // 单位
  description  String?  // 描述
  isSystem     Boolean  @default(false) // 是否系统默认
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([type])
  @@index([userId])
}